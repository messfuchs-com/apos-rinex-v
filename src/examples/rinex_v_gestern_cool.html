<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
	<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
	<title>gestern_rinex_v.html</title>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
	 crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.3.1/dist/semantic.min.css">
	<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.3.1/dist/semantic.min.js"></script>

</head>

<body>
	<br>
	<h1>Gestern</h1>
	<div class="ui" id="id_station_cards">
		<div class="ui card">
			<div class="content">
				<i class="bolt icon"></i>
				XXXX
			</div>
			<div class="content">
				<span class="right floated">
					<i class="heart outline like icon"></i>
					17 likes
				</span>
				<i class="comment icon"></i>
				3 comments
			</div>
			<div class="extra content">
				<div class="ui large transparent left icon input">
					<i class="heart outline icon"></i>
					<input placeholder="Add Comment..." type="text">
				</div>
			</div>
		</div>
	</div>

	<script>
		var parser, xmlDoc;
		var rinexData = {
			providers: {}
		};
		let provider = "???(?)";

		parser = new DOMParser();
		var xhttp = new XMLHttpRequest();
		var stationName;

		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				// Typical action to be performed when the document is ready
				var parser = new DOMParser();
				xmlDoc = parser.parseFromString(xhttp.responseText, "text/html");
				var allGaps = {};
				var tmpGaps = null;
				var gapList = [];
				var stations = xmlDoc.getElementsByTagName("tr");
				// Get Table Row
				for (var i = 0; i < stations.length; i++) {

					var tableColumns = stations[i].children;

					if (tableColumns[0].hasAttribute("colspan") && tableColumns[0].getAttribute("colspan") === "6") {
						provider = tableColumns[0].children[0].children[0].getAttribute("name");
						console.log("new Provider: " + provider);
					}

					if (tableColumns.length <= 4 && tableColumns.length >= 3) {
						
						if (tableColumns.length > 3 && tableColumns[0].children[0].innerHTML === "Station") continue;
						if (tableColumns.length === 4) {
							stationName = tableColumns[0].children[0].innerHTML.replace(/\ /g, '').replace(/\n/g, '');
						}

						if (!(stationName in allGaps)) {
							allGaps[stationName] = {};
						}

						console.log("Found a Detail for station " + stationName);
						if (!('detail' in allGaps[stationName])) {
							allGaps[stationName]['detail'] = [];
						}

						switch(tableColumns.length) {
							case 4:
								var timeWindow = tableColumns[1].innerHTML;
								var duranceSec = parseInt(tableColumns[2].innerHTML);
								var duranceHour = tableColumns[3].innerHTML;
								break;
							case 3:
								var timeWindow = tableColumns[0].innerHTML;
								var duranceSec = parseInt(tableColumns[1].innerHTML);
								var duranceHour = tableColumns[2].innerHTML;
								break;
							default:
							    null;								
						}
						timeWindow = timeWindow.replace(/\ /g, '').replace(/\n/g, '').replace('-', ' ').split(' ');
						var duranceFrom = timeWindow[0];
						var duranceUntil = timeWindow[1];

						allGaps[stationName].detail.push(
							{
								sId: stationName,
								duranceFrom: duranceFrom,
								duranceUntil: duranceUntil,
								duranceSec: duranceSec,
								duranceHour: duranceHour
							}
						)

						console.log(allGaps[stationName]);
					}

					if (tableColumns.length < 6) continue;

					tempGaps = {};
					stationName = tableColumns[0].innerText;
					var stationProvider = provider;
					var stationGapsBigger = parseInt(tableColumns[2].innerText);
					var stationGapsLesser = parseInt(tableColumns[3].innerText);
					var stationPercentage = parseFloat(tableColumns[5].innerText.replace('%s', '').replace(",", "."));
					if (stationName.length > 4) continue;
					var params = stations[i].getElementsByTagName("param");
					var numberOfGaps = 0;
					if (!(stationName in allGaps)) {
						console.log('Station ' + stationName + ' not in Data');
						allGaps[stationName] = {};
					}
					if (!('detail' in allGaps[stationName])) {
						allGaps[stationName].detail = [];
					}
					allGaps[stationName]['sId'] = stationName;
					allGaps[stationName]['provider'] = stationProvider;
					allGaps[stationName]['gapsBigger'] = stationGapsBigger;
					allGaps[stationName]['gapsLesser'] = stationGapsLesser;
					allGaps[stationName]['percentage'] = stationPercentage;
					if (!('gaps' in allGaps[stationName])) {
						allGaps[stationName]['gaps'] = [];
					}

					for (var j = 0; j < params.length; j++) {
						if (params[j].name === 'ngaps') {
							numberOfGaps = parseInt(params[j].value);
						}
						if (params[j].name.startsWith('gapbegin')) {
							var gapId = params[j].name.replace("gapbegin", "");
							var gapValue = params[j].value;
							if (!(gapId in tempGaps)) {
								tempGaps[gapId] = {};
							};
							tempGaps[gapId].gId = gapId;
							tempGaps[gapId].gBegin = gapValue;

						}
						if (params[j].name.startsWith('gapend')) {
							var gapId = params[j].name.replace("gapend", "");
							var gapValue = params[j].value;
							tempGaps[gapId].gEnd = gapValue;
						}
					}

					Object.keys(tempGaps).forEach(gap => {
						allGaps[stationName]['gaps'].push(tempGaps[gap]);
					})
				}

				console.log('Create Providers in Object');
				Object.keys(allGaps).forEach(gap => {
					provider = allGaps[gap].provider;
					if (!(provider in rinexData.providers)) {
						rinexData.providers[provider] = {
							stations: []
						};
					}
					rinexData.providers[provider]['stations'].push(allGaps[gap]);
					gapList.push(allGaps[gap]);
				})
				
				console.log(rinexData);
				// console.log(gapList);
			}
		};
		xhttp.open("GET", "rinex_v_gestern.html", true);
		xhttp.send();
	</script>
</body>

</html>